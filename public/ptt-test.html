<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PTT Test - Mindful Champion</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 600px;
            width: 100%;
        }
        
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .status {
            background: #f3f4f6;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin: 10px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
        }
        
        .status-label {
            font-weight: 600;
            color: #333;
        }
        
        .status-value {
            font-size: 20px;
        }
        
        .ptt-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 20px;
            margin: 30px 0;
        }
        
        #pttButton {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            border: none;
            background: linear-gradient(135deg, #14b8a6, #0891b2);
            color: white;
            font-size: 60px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(20, 184, 166, 0.3);
            position: relative;
            overflow: hidden;
        }
        
        #pttButton:hover {
            transform: scale(1.05);
            box-shadow: 0 15px 40px rgba(20, 184, 166, 0.4);
        }
        
        #pttButton:active {
            transform: scale(0.95);
        }
        
        #pttButton.recording {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            animation: pulse 1.5s infinite;
        }
        
        #pttButton.processing {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
        }
        
        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
            }
            50% {
                box-shadow: 0 10px 50px rgba(239, 68, 68, 0.6);
            }
        }
        
        .ptt-status {
            text-align: center;
            font-size: 18px;
            font-weight: 600;
            color: #333;
            min-height: 30px;
        }
        
        .transcript-box {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .transcript-label {
            font-weight: 600;
            color: #666;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .transcript-text {
            color: #111;
            line-height: 1.6;
            font-size: 16px;
        }
        
        .interim {
            color: #999;
            font-style: italic;
        }
        
        .log {
            background: #1f2937;
            color: #10b981;
            border-radius: 12px;
            padding: 15px;
            margin-top: 20px;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }
        
        .log-entry {
            margin: 5px 0;
        }
        
        .error {
            color: #ef4444;
        }
        
        .success {
            color: #10b981;
        }
        
        .warning {
            color: #f59e0b;
        }
        
        .info {
            color: #3b82f6;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üé§ PTT Diagnostic Test</h1>
        <p class="subtitle">Push-to-Talk Functionality Test for Mindful Champion</p>
        
        <div class="status">
            <div class="status-item">
                <span class="status-label">Speech Recognition API</span>
                <span class="status-value" id="apiStatus">‚ùì</span>
            </div>
            <div class="status-item">
                <span class="status-label">Microphone Permission</span>
                <span class="status-value" id="micStatus">‚ùì</span>
            </div>
            <div class="status-item">
                <span class="status-label">Browser</span>
                <span class="status-value" id="browserInfo">-</span>
            </div>
        </div>
        
        <div class="ptt-container">
            <button id="pttButton">üé§</button>
            <div class="ptt-status" id="pttStatus">Press & Hold to Talk</div>
        </div>
        
        <div class="transcript-box">
            <div class="transcript-label">Live Transcript:</div>
            <div class="transcript-text" id="transcriptText">
                <span style="color: #999;">Transcript will appear here...</span>
            </div>
        </div>
        
        <div class="log" id="debugLog"></div>
    </div>
    
    <script>
        // Debug logging
        const debugLog = document.getElementById('debugLog');
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const timestamp = new Date().toLocaleTimeString();
            entry.textContent = `[${timestamp}] ${message}`;
            debugLog.appendChild(entry);
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }
        
        // Status elements
        const apiStatus = document.getElementById('apiStatus');
        const micStatus = document.getElementById('micStatus');
        const browserInfo = document.getElementById('browserInfo');
        const pttButton = document.getElementById('pttButton');
        const pttStatus = document.getElementById('pttStatus');
        const transcriptText = document.getElementById('transcriptText');
        
        // State
        let recognition = null;
        let isHolding = false;
        let transcript = '';
        let interimTranscript = '';
        
        // Initialize
        log('üöÄ Initializing PTT Test...', 'info');
        
        // Check browser
        const userAgent = navigator.userAgent;
        let browserName = 'Unknown';
        if (userAgent.includes('Chrome') && !userAgent.includes('Edg')) browserName = 'Chrome';
        else if (userAgent.includes('Edg')) browserName = 'Edge';
        else if (userAgent.includes('Safari') && !userAgent.includes('Chrome')) browserName = 'Safari';
        else if (userAgent.includes('Firefox')) browserName = 'Firefox';
        browserInfo.textContent = browserName;
        log(`Browser detected: ${browserName}`, 'info');
        
        // Check Speech Recognition API
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        if (!SpeechRecognition) {
            apiStatus.textContent = '‚ùå';
            log('‚ùå Speech Recognition API not available!', 'error');
            pttStatus.textContent = 'Speech Recognition not supported in this browser';
            pttButton.disabled = true;
        } else {
            apiStatus.textContent = '‚úÖ';
            log('‚úÖ Speech Recognition API available', 'success');
            
            // Initialize recognition
            recognition = new SpeechRecognition();
            recognition.continuous = true;
            recognition.interimResults = true;
            recognition.lang = 'en-US';
            recognition.maxAlternatives = 1;
            
            log('‚úÖ Speech Recognition initialized', 'success');
            
            // Recognition event handlers
            recognition.onstart = () => {
                log('üé§ Recording started', 'success');
                pttButton.className = 'recording';
                pttButton.textContent = 'üî¥';
                pttStatus.textContent = 'Recording... Keep holding & speak clearly';
            };
            
            recognition.onend = () => {
                log('üõë Recognition ended', 'info');
                if (isHolding) {
                    log('üîÑ User still holding - restarting recognition', 'warning');
                    setTimeout(() => {
                        if (isHolding) {
                            try {
                                recognition.start();
                                log('‚úÖ Recognition restarted', 'success');
                            } catch (err) {
                                log(`‚ùå Failed to restart: ${err.message}`, 'error');
                            }
                        }
                    }, 50);
                }
            };
            
            recognition.onerror = (event) => {
                log(`‚ùå Recognition error: ${event.error}`, 'error');
                
                switch (event.error) {
                    case 'not-allowed':
                    case 'service-not-allowed':
                        micStatus.textContent = '‚ùå';
                        pttStatus.textContent = 'Microphone access denied';
                        break;
                    case 'no-speech':
                        log('‚ö†Ô∏è No speech detected', 'warning');
                        break;
                    case 'network':
                        pttStatus.textContent = 'Network error - trying again...';
                        break;
                    case 'aborted':
                        log('‚ÑπÔ∏è Recognition aborted (normal)', 'info');
                        break;
                    case 'audio-capture':
                        micStatus.textContent = '‚ùå';
                        pttStatus.textContent = 'Microphone error';
                        break;
                }
            };
            
            recognition.onresult = (event) => {
                let finalText = '';
                let interim = '';
                
                for (let i = event.resultIndex; i < event.results.length; i++) {
                    const result = event.results[i];
                    const text = result[0].transcript;
                    
                    if (result.isFinal) {
                        finalText += text + ' ';
                        log(`üìù Final: "${text}"`, 'success');
                    } else {
                        interim += text;
                    }
                }
                
                if (finalText.trim()) {
                    transcript += finalText;
                }
                
                interimTranscript = interim;
                
                // Update display
                transcriptText.innerHTML = `
                    <span class="final">${transcript}</span>
                    <span class="interim">${interimTranscript}</span>
                `;
            };
        }
        
        // Request microphone permission
        async function requestMicPermission() {
            log('üé§ Requesting microphone permission...', 'info');
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true
                    }
                });
                
                micStatus.textContent = '‚úÖ';
                log('‚úÖ Microphone permission granted!', 'success');
                
                // Keep stream active
                window.micStream = stream;
                
                return true;
            } catch (err) {
                micStatus.textContent = '‚ùå';
                log(`‚ùå Microphone permission error: ${err.name} - ${err.message}`, 'error');
                
                if (err.name === 'NotAllowedError' || err.name === 'PermissionDeniedError') {
                    pttStatus.textContent = 'Please allow microphone access';
                } else if (err.name === 'NotFoundError') {
                    pttStatus.textContent = 'No microphone found';
                } else {
                    pttStatus.textContent = 'Click button to enable microphone';
                }
                
                return false;
            }
        }
        
        // Request permission on page load
        requestMicPermission();
        
        // PTT Button handlers
        async function handlePTTStart(event) {
            event.preventDefault();
            log('üü¢ PTT button pressed', 'info');
            
            if (!recognition) {
                log('‚ùå Recognition not initialized', 'error');
                return;
            }
            
            // Request mic permission if not granted
            if (micStatus.textContent !== '‚úÖ') {
                const granted = await requestMicPermission();
                if (!granted) return;
            }
            
            isHolding = true;
            transcript = '';
            interimTranscript = '';
            transcriptText.innerHTML = '<span style="color: #999;">Listening...</span>';
            
            try {
                recognition.start();
                log('‚úÖ Recognition started successfully', 'success');
            } catch (err) {
                log(`‚ùå Start error: ${err.message}`, 'error');
                
                if (err.name === 'InvalidStateError') {
                    log('‚ö†Ô∏è Recognition already running, stopping and restarting...', 'warning');
                    recognition.stop();
                    setTimeout(() => {
                        if (isHolding) recognition.start();
                    }, 100);
                }
            }
        }
        
        function handlePTTEnd(event) {
            if (event) event.preventDefault();
            
            if (!isHolding) return;
            
            log('üî¥ PTT button released', 'info');
            isHolding = false;
            
            pttButton.className = 'processing';
            pttButton.textContent = '‚è≥';
            pttStatus.textContent = 'Processing...';
            
            if (recognition) {
                try {
                    recognition.stop();
                    log('‚úã Recognition stopped', 'info');
                } catch (err) {
                    log(`‚ö†Ô∏è Stop error: ${err.message}`, 'warning');
                }
            }
            
            setTimeout(() => {
                pttButton.className = '';
                pttButton.textContent = 'üé§';
                pttStatus.textContent = 'Press & Hold to Talk';
                
                if (transcript.trim()) {
                    log(`‚úÖ Final transcript: "${transcript.trim()}"`, 'success');
                } else {
                    log('üì≠ No transcript captured', 'warning');
                    transcriptText.innerHTML = '<span style="color: #999;">No speech detected. Try again!</span>';
                }
            }, 1000);
        }
        
        // Mouse events
        pttButton.addEventListener('mousedown', handlePTTStart);
        pttButton.addEventListener('mouseup', handlePTTEnd);
        pttButton.addEventListener('mouseleave', handlePTTEnd);
        
        // Touch events
        pttButton.addEventListener('touchstart', handlePTTStart);
        pttButton.addEventListener('touchend', handlePTTEnd);
        pttButton.addEventListener('touchcancel', handlePTTEnd);
        
        // Prevent context menu
        pttButton.addEventListener('contextmenu', (e) => e.preventDefault());
        
        log('‚úÖ PTT Test initialized successfully!', 'success');
        log('‚ÑπÔ∏è Press and hold the button to start recording', 'info');
    </script>
</body>
</html>
